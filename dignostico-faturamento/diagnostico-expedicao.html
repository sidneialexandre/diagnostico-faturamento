<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Mapeamento e Diagnóstico de Processo</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6f8;margin:20px}
.card{background:#fff;padding:20px;margin-bottom:20px;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1)}
h1,h2,h3{color:#2c3e50}
h2{border-bottom:2px solid #ddd;padding-bottom:5px}
label{font-weight:bold}
input,textarea{margin:5px 0 12px 0;padding:6px}
input[type=number]{width:70px}
textarea{width:100%;min-height:80px;resize:vertical}
.question{border-left:4px solid #3498db;padding-left:10px;margin-bottom:15px}
button{padding:10px 15px;font-size:14px;margin-right:10px}
.section-desc{font-style:italic;color:#555;margin-bottom:15px}
table input{width:95%}
</style>
</head>
<body>

<h1>Mapeamento e Diagnóstico de Processo</h1>

<div class="card">
<h2>Identificação do Processo</h2>
<label>Nome do Processo Avaliado:</label>
<input type="text" id="nomeProcesso" style="width:100%" placeholder="Ex: Processo de Faturamento e Expedição – Unidade SC">
</div>

<div class="card">
<h2>Identificação dos Entrevistados</h2>
<p class="section-desc">Informe todos os participantes da entrevista. Utilize uma linha por pessoa.</p>
<table style="width:100%;border-collapse:collapse" id="tabelaEntrevistados">
<thead>
<tr style="background:#eef2f5">
<th style="border:1px solid #ccc;padding:6px">Nome</th>
<th style="border:1px solid #ccc;padding:6px">Cargo</th>
<th style="border:1px solid #ccc;padding:6px">E-mail</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border:1px solid #ccc"><input></td>
<td style="border:1px solid #ccc"><input></td>
<td style="border:1px solid #ccc"><input></td>
</tr>
</tbody>
</table>
<button style="margin-top:10px" onclick="adicionarEntrevistado()">Adicionar Entrevistado</button>
</div>

<div id="formulario"></div>

<div class="card">
<h2>Resultado do Diagnóstico</h2>
<p id="resultado"></p>
<canvas id="radar"></canvas>
</div>

<div class="card">
<button onclick="salvar()">Salvar Avaliação</button>
<button onclick="exportarPDF()">Exportar PDF</button>
<button onclick="calcular()">Calcular Diagnóstico</button>
</div>

<script>

const estrutura=[
{nome:'Governança do Processo (Visão Geral)',peso:1,perguntas:[
'Existe definição clara de papéis e responsabilidades entre Faturamento, Expedição e Comercial?',
'Os processos estão formalizados e documentados?',
'Existe gestão estruturada de exceções (entrega futura, contra ordem, transferências)?',
'Existe dono claro do processo ponta a ponta?'
]},
{nome:'Entrada de Pedidos e Integração Comercial',peso:1,perguntas:[
'Pedidos chegam completos e corretos para faturamento?',
'Integração Comercial x ERP é confiável?',
'Existe retrabalho frequente por erro de pedido?',
'Regras comerciais estão corretamente parametrizadas?'
]},
{nome:'Planejamento de Expedição e Sequenciamento',peso:1,perguntas:[
'Existe planejamento formal de expedição?',
'O sequenciamento respeita prioridades e janelas?',
'Alterações são controladas?',
'O plano executado reflete o planejado?'
]},
{nome:'WMS – Endereçamento, Separação e Movimentação',peso:1,perguntas:[
'Endereçamento é lógico e confiável?',
'Erros de picking são recorrentes?',
'Todas as movimentações são registradas no WMS?',
'Acuracidade física é confiável?'
]},
{nome:'Faturamento (ERP + Fiscal)',peso:2,perguntas:[
'NFs são emitidas corretamente na primeira vez?',
'Operações especiais estão corretamente parametrizadas?',
'Existem riscos fiscais recorrentes?',
'Faturamento está sincronizado com a expedição?'
]},
{nome:'Integração ERP x WMS',peso:1,perguntas:[
'Pedidos faturados refletem corretamente no WMS?',
'Existem falhas de integração frequentes?',
'Interfaces possuem monitoramento?',
'Erros de integração são tratados sistematicamente?'
]},
{nome:'Carregamento e Expedição Física',peso:1,perguntas:[
'Carregamentos seguem a ordem planejada?',
'Existe conferência antes da saída?',
'Atrasos de carregamento são frequentes?',
'Ocorrências são registradas e tratadas?'
]},
{nome:'Pessoas, Treinamento e Disciplina Operacional',peso:1,perguntas:[
'Equipes são treinadas adequadamente?',
'Rotatividade impacta a operação?',
'Procedimentos são seguidos?',
'Existe reciclagem periódica?'
]},
{nome:'Indicadores, Controles e Melhoria Contínua',peso:1,perguntas:[
'Existem KPIs claros?',
'Indicadores são analisados regularmente?',
'Ações corretivas são executadas?',
'Existe histórico de melhoria contínua?'
]},
{nome:'Riscos e Impactos',peso:2,perguntas:[
'Riscos operacionais e fiscais são mapeados?',
'Impactos financeiros são mensurados?',
'Planos de contingência existem?',
'Riscos são monitorados continuamente?'
]}
];

const form=document.getElementById('formulario');
estrutura.forEach((p,i)=>{
 const card=document.createElement('div');
 card.className='card';
 card.innerHTML=`<h2>${i+1}. ${p.nome}</h2><div class='section-desc'>Peso do pilar: ${p.peso}</div>`;
 p.perguntas.forEach((q,j)=>{
  card.innerHTML+=`<div class='question'>
  <label>${q}</label>
  <input type='number' min='0' max='5' id='p${i}_${j}'>
  <textarea placeholder='Observações / Evidências' id='p${i}_${j}_obs'></textarea>
  </div>`;
 });
 form.appendChild(card);
});

function calcular(){
 let total=0;
 const radar=[];
 estrutura.forEach((p,i)=>{
  let soma=0;
  p.perguntas.forEach((_,j)=>{
   const v=parseFloat(document.getElementById(`p${i}_${j}`).value)||0;
   soma+=v;
  });
  const media=soma/p.perguntas.length;
  radar.push(media);
  total+=media*p.peso;
 });
 const score=(total/estrutura.reduce((a,b)=>a+b.peso,0)).toFixed(2);
 document.getElementById('resultado').innerText='Score Geral Ponderado: '+score;
 new Chart(document.getElementById('radar'),{
  type:'radar',
  data:{
   labels:estrutura.map(p=>p.nome),
   datasets:[{label:'Score por Pilar',data:radar}]
  }
 });
}

function adicionarEntrevistado(){
 const tb=document.querySelector('#tabelaEntrevistados tbody');
 const tr=document.createElement('tr');
 tr.innerHTML=`<td style='border:1px solid #ccc'><input></td><td style='border:1px solid #ccc'><input></td><td style='border:1px solid #ccc'><input></td>`;
 tb.appendChild(tr);
}

function salvar(){
 const entrevistados=[];
 document.querySelectorAll('#tabelaEntrevistados tbody tr').forEach(tr=>{
  const tds=tr.querySelectorAll('input');
  if(tds[0].value){
   entrevistados.push({nome:tds[0].value,cargo:tds[1].value,email:tds[2].value});
  }
 });
 const dados={data:new Date().toISOString(),entrevistados,respostas:{}};
 estrutura.forEach((p,i)=>{
  dados.respostas[p.nome]=[];
  p.perguntas.forEach((q,j)=>{
   dados.respostas[p.nome].push({
    pergunta:q,
    nota:document.getElementById(`p${i}_${j}`).value,
    obs:document.getElementById(`p${i}_${j}_obs`).value
   });
  });
 });
 localStorage.setItem('diagnostico_'+dados.data,JSON.stringify(dados));
 alert('Avaliação salva com sucesso');
}

async function exportarPDF(){
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF('p','mm','a4');
 let y = 15;

 // Calcular scores
 let total=0;
 const radarData=[];
 estrutura.forEach((p,i)=>{
  let soma=0;
  p.perguntas.forEach((_,j)=>{
   const v=parseFloat(document.getElementById(`p${i}_${j}`).value)||0;
   soma+=v;
  });
  const media=soma/p.perguntas.length;
  radarData.push(media);
  total+=media*p.peso;
 });
 const scoreGeral=(total/estrutura.reduce((a,b)=>a+b.peso,0)).toFixed(2);

 doc.setFontSize(16);
 doc.text('Mapeamento e Diagnóstico de Processo', 14, y);
 y += 8;

 doc.setFontSize(11);
 const nomeProcesso = document.getElementById('nomeProcesso')?.value || 'Não informado';
 doc.text('Processo: ' + nomeProcesso, 14, y);
 y += 6;
 doc.text('Data: ' + new Date().toLocaleString(), 14, y);
 y += 6;
 doc.setFontSize(12);
 doc.text('Score Geral Ponderado: ' + scoreGeral, 14, y);
 y += 10;

 // Gerar gráfico radar como imagem
 const canvasRadar = document.getElementById('radar');
 const imgData = canvasRadar.toDataURL('image/png',1.0);
 doc.addImage(imgData,'PNG',15,y,180,80);
 y += 90;

 // Entrevistados
 const entrevistados=[];
 document.querySelectorAll('#tabelaEntrevistados tbody tr').forEach(tr=>{
  const tds=tr.querySelectorAll('input');
  if(tds[0].value){
   entrevistados.push([tds[0].value,tds[1].value,tds[2].value]);
  }
 });

 if(entrevistados.length>0){
  doc.autoTable({
   startY:y,
   head:[["Nome","Cargo","E-mail"]],
   body:entrevistados,
   theme:'grid',
   styles:{fontSize:8}
  });
  y=doc.lastAutoTable.finalY+10;
 }

 // Detalhamento completo por Pilar
 estrutura.forEach((p,i)=>{
  if(y>260){doc.addPage(); y=15;}

  doc.setFontSize(12);
  doc.text((i+1)+'. '+p.nome,14,y);
  y+=6;

  let soma=0;
  const criticos=[];

  p.perguntas.forEach((q,j)=>{
   const nota=parseFloat(document.getElementById(`p${i}_${j}`).value)||0;
   const obs=document.getElementById(`p${i}_${j}_obs`).value || '';
   soma+=nota;
   if(nota<=2) criticos.push(q);

   if(y>260){doc.addPage(); y=15;}

   doc.setFontSize(9);
   const perguntaLines=doc.splitTextToSize('Pergunta: '+q,170);
   doc.text(perguntaLines,16,y);
   y+=perguntaLines.length*4;

   doc.text('Nota: '+nota,18,y);
   y+=4;

   if(obs){
    const obsLines=doc.splitTextToSize('Observações: '+obs,165);
    doc.text(obsLines,18,y);
    y+=obsLines.length*4;
   }

   y+=4;
  });

  const media=(soma/p.perguntas.length).toFixed(2);

  if(y>250){doc.addPage(); y=15;}

  doc.setFontSize(11);
  doc.text('Resumo do Pilar – Média: '+media,16,y);
  y+=6;

  doc.setFontSize(9);
  if(criticos.length>0){
   doc.text('Pontos Críticos Identificados:',18,y);
   y+=5;
   criticos.forEach(c=>{
    const lines=doc.splitTextToSize('- '+c,165);
    doc.text(lines,20,y);
    y+=lines.length*4;
   });
  } else {
   doc.text('Não foram identificados pontos críticos relevantes neste pilar.',18,y);
   y+=6;
  }

  doc.text('Direcionamento de Melhoria: Revisar fluxos, reforçar controles e estruturar plano de ação específico para as fragilidades identificadas.',18,y);
  y+=10;
 });

 doc.save('Mapeamento_Diagnostico_Processo.pdf');
}

</script>

</body>
</html>
